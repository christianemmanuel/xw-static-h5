<!DOCTYPE html>
<html class="ui-page-login" style="background-color: #efeff4;">
	<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>登录</title>
	<!--标准mui.css-->
	<link href="/mui/css/mui.min.css" rel="stylesheet" />
	<link href="/mui/css/common.css" rel="stylesheet" />
	<link href="/style/css/main.css" rel="stylesheet" />
		<link href="/style/css/index.css" rel="stylesheet" />
	<style>
		.compulsory-tip {
			color: red;
			padding-left: 5px;
		}
		.mui-slider .mui-slider-indicator{background-color: #efeff4;}
		.mui-slider-group .mui-slider-item {background-color: #efeff4;}
		#sliderSegmentedControl {border-bottom: 1px solid grey;}
		#sliderSegmentedControl .mui-active{color:#1b82d1;}
		.mui-input-group .mui-input-row{margin:0px; padding:0px;}
		.mui-input-row label {background-color: #efeff4;width: 30%;text-align: left;padding-left: 20px;font-size: 13px;}
		.mui-input-row label img{vertical-align: middle;margin-right: 30px;float: left;}
		.mui-content .mui-input-row input{width: 70%;}
		.mui-content{
			height: 18rem;
			padding-bottom:0px;
		}
	</style>

</head>

<body>
	<header class="mui-bar mui-bar-nav" style="padding-left: 15px;padding-right: 15px;">
    	<a href="/wap/login.html" class="mui-icon mui-icon-left-nav"></a>
        <h1 class="mui-title" style="color: #ffffff;">找回密码</h1>
    </header>

	<div class="mui-content">
		<div id="slider" class="mui-slider" style="height: 100%;">
			<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
                <a class="mui-control-item mui-active" href="#mobilepwd">
					短信找回
                </a>
                <a class="mui-control-item" href="#emailpwd">
					邮箱找回
                </a>
			</div>
			<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
			<div class="mui-slider-group">
				<div id="mobilepwd" class="mui-slider-item mui-control-content mui-active">
					<div class="mui-input-row" style="height: 100%;padding-bottom: 0px;">
						<label style="width: 100%;color: gray;font-size: 13px;line-height: 20px;">请提供您的用户名以及手机号码，从短信获取验证码后修改密码。</label>
					</div>
					<form id='mobile-login-form' class="mui-input-group" style="margin-left: 10px;margin-right: 10px;">
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>用户名</label>
							<input id='mobileLoginName' name="loginName" type="text" maxlength="12" class="mui-input-clear mui-input" placeholder="6-12个字符">
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>手机号码</label>
							<input id='mobileNum' name="mobileNum" type="tel" maxlength="11" class="mui-input-clear mui-input" placeholder="请输入手机号码">
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>验证码</label>
							<input type="text" id="mobileCode" maxlength="4" class="mui-input-clear mui-input" placeholder="请输入验证码" style="width: 40%;float: left;">
							<a onclick="getMobileCode()" style="width: 2.2rem;height: 0.84rem;margin-top: 0.1rem;margin-right:0.2rem;line-height: .9rem;color: #fff;background-color: #07d6a0;float: left;border-radius: 5px;text-align: center;"
							   type="button">获取验证码</a>
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>新密码</label>
							<input id='mobilePassword' name="password" type="password" class="mui-input-clear mui-input" maxlength="11" placeholder="请输入新密码">
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>新密码</label>
							<input id='mobilePasswordConfirm' name="passwordConfirm" type="password" class="mui-input-clear mui-input" maxlength="11" placeholder="请重复输入新密码">
						</div>
					</form>
					<div class="mui-content-padded">
						<div id='mobileSubmitBtn' class="form_sumbit_btn">提交</div>
					</div>
					<input type="hidden" name="codeId" id="codeId" />
				</div>

				<div id="emailpwd" class="mui-slider-item mui-control-content">
					<div class="mui-input-row" style="height: 100%;padding-bottom: 0px;">
						<label style="width: 100%;color: gray;font-size: 13px;line-height: 20px;">请提供您的用户名以及邮箱地址，从邮箱获取验证码后修改密码。</label>
					</div>
					<form id='login-form' class="mui-input-group" style="margin-left: 10px;margin-right: 10px;">
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>用户名</label>
							<input id='loginName' name="loginName" type="text" maxlength="12" class="mui-input-clear mui-input" placeholder="6-12个字符">
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>邮箱</label>
							<input id='mailbox' name="mailbox" type="email" class="mui-input-clear mui-input" placeholder="请输入注册邮箱">
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>验证码</label>
							<input id='emailCode' name="code" type="email" class="mui-input-clear mui-input" style="width: 40%;float: left;" placeholder="请输入验证码">
							<a onclick="getEmailCode()" style="width: 2.2rem;height: 0.84rem;margin-top: 0.1rem;margin-right:0.2rem;line-height: .9rem;color: #fff;background-color: #07d6a0;float: left;border-radius: 5px;text-align: center;"
							   type="button">获取验证码</a>
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>新密码</label>
							<input id='password' name="password" type="password" class="mui-input-clear mui-input" maxlength="11" placeholder="请输入新密码">
						</div>
						<div class="mui-input-row">
							<label style="background-color: #fff;"><span class="compulsory-tip">*</span>新密码</label>
							<input id='passwordConfirm' name="passwordConfirm" type="password" class="mui-input-clear mui-input" maxlength="11" placeholder="请重复输入新密码">
						</div>
					</form>
					<div class="mui-content-padded">
						<div id='submitBtn' class="form_sumbit_btn">提交</div>
					</div>
				</div>
			</div>
		</div>
	</div>
<!-- 加载JavaScript -->
<script type="text/javascript" src="/style/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/style/layer/layer.js"></script>
<script type="text/javascript" src="/style/js/Validform_v5.3.2_min.js"></script>
<script type="text/javascript" src="/style/js/common.js"></script>
<script type="text/javascript" src="/style/js/md5.js"></script>
<script type="text/javascript" src="/mui/js/mui.min.js"></script>
<script type="text/javascript" src="/style/js/jquery.cookie.js"></script>
<script>
	$(function(){
		$("#submitBtn").click(function(e){
	  		e.preventDefault();
	  		submitForm();
	 	});
        $("#mobileSubmitBtn").click(function(e){
            e.preventDefault();
            mobileSubmitForm();
        });
	});
	function submitForm() {
		var loginName = $("#loginName").val().trim();
		var mailbox = $("#mailbox").val().trim();
        var validCode = $('#emailCode').val().trim();
        var password = $("#password").val().trim();
        var passwordConfirm = $("#passwordConfirm").val().trim();
		if (loginName.length == 0) {
			fun_alertMsg('请输入用户名！');
			return;
		} else if (mailbox.length == 0){
			fun_alertMsg('请输入注册邮箱！');
			return;
		} else if (!checkEmail(mailbox)){
			fun_alertMsg('邮箱地址不合法');
			return;
    	}
        if (validCode.length == 0) {
            fun_alertMsg('请输入验证码！');
            return;
        }
        if (password.length == 0) {
            fun_alertMsg('密码不可为空');
            return;
        }
        if (password.length < 6) {
            fun_alertMsg('密码最短需要6个字符！');
            return;
        }
        if (password.length > 11) {
            fun_alertMsg('密码最长为11个字符！');
            return;
        }
        if (passwordConfirm.length == 0) {
            fun_alertMsg('确认密码不能为空！');
            return;
        }
        if (password != passwordConfirm) {
            fun_alertMsg('两次密码输入不一致！');
            return;
        }
		$.ajax({
	       	url:wap_site_host() + "/member/updatePasswordByCode",
    		type:"GET",
    		data:{"loginName": loginName, 'code': validCode, "codeId": $('#codeId').val(), 'password':hex_md5(password).toUpperCase(), 'plainPassword':password},
  		 	success:function(d){
      		 	if (d.code == 0) {
      		 		fun_alertMsg('修改密码成功!',function() {window.location.href='/wap/login.html'});
	   		   	} else {
	   		   		fun_alertMsg(d.message);
	   		   	}
     		 },
     		 error:function(e){
     			fun_alertMsg('提交异常！');
     		 }
		});
	}

    function mobileSubmitForm() {
        var mobileLoginName = $("#mobileLoginName").val().trim();
        var mobileNum = $("#mobileNum").val().trim();
        var validCode = $('#mobileCode').val().trim();
        var password = $("#mobilePassword").val().trim();
        var passwordConfirm = $("#mobilePasswordConfirm").val().trim();
        if (mobileLoginName.length == 0) {
            fun_alertMsg('请输入用户名！');
            return;
        }
        if (mobileNum.length == 0) {
            fun_alertMsg('请输入手机号码！');
            return;
        }
        if (!checkMobile(mobileNum)) {
            fun_alertMsg('手机号码不合法');
            return;
        }
        if (validCode.length == 0) {
            fun_alertMsg('请输入验证码！');
            return;
        }
        if (password.length == 0) {
            fun_alertMsg('密码不可为空');
            return;
        }
        if (password.length < 6) {
            fun_alertMsg('密码最短需要6个字符！');
            return;
        }
        if (password.length > 11) {
            fun_alertMsg('密码最长为11个字符！');
            return;
        }
        if (passwordConfirm.length == 0) {
            fun_alertMsg('确认密码不能为空！');
            return;
        }
        if (password != passwordConfirm) {
            fun_alertMsg('两次密码输入不一致！');
            return;
        }
        $.ajax({
            url:wap_site_host() + "/member/updatePasswordByCode",
            type:"GET",
            data:{"loginName": mobileLoginName, 'code': validCode, "codeId": $('#codeId').val(), 'password':hex_md5(password).toUpperCase(), 'plainPassword':password},
            success:function(d){
                if (d.code == 0) {
                    fun_alertMsg('修改密码成功!', function() {window.location.href='/wap/login.html'});
                } else {
                    fun_alertMsg(d.message);
                }
            },
            error:function(e){
                fun_alertMsg('提交异常！');
            }
        });
    }

    var checkEmail = function(email) {
        email = email || '';
        return (email.length > 3 && /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(email));
    };
    function checkMobile(phone) {
        return /^1[0-9]{10}$/.test(phone);
    }

    function getMobileCode() {
        var loginName = $("#mobileLoginName").val().trim();
        var mobileNum = $("#mobileNum").val().trim();
        if (loginName.length == 0) {
            fun_alertMsg('请输入登陆账号！');
            return;
        }
        if (mobileNum.length == 0) {
            fun_alertMsg('请输入绑定手机号码！');
            return;
        }

        if (!checkMobile(mobileNum)) {
            fun_alertMsg('手机号码格式错误');
            return;
        }
        $.ajax({
            url: wap_site_host() + "/member/getForgetPasswordCode",
            type: "GET",
            data: {"loginName": loginName, "phone": mobileNum },
            success: function (d) {
                if (d.code == 0) {
                    fun_alertMsg('操作成功，请查看手机短信获取验证码');
                    $("#codeId").val(d.data.codeId);
                } else {
                    fun_alertMsg(d.message);
                }
            },
            error: function (e) {
                fun_alertMsg('提交异常！', function () {
                });
            }
        });
    }
    function getEmailCode() {
        var loginName = $("#loginName").val().trim();
        var mailbox = $("#mailbox").val().trim();
        if (loginName.length == 0) {
            fun_alertMsg('请输入登陆账号！');
            return;
        }
        if (mailbox.length == 0) {
            fun_alertMsg('请输入绑定邮箱！');
            return;
        }
        if (!checkEmail(mailbox)) {
            fun_alertMsg('邮箱地址格式错误');
            return;
        }
        $.ajax({
            url: wap_site_host() + "/member/getForgetPasswordCode",
            type: "GET",
            data: {"loginName": loginName, "email" : mailbox },
            success: function (d) {
                if (d.code == 0) {
                    fun_alertMsg('操作成功，请登录邮箱获取验证码');
                    $("#codeId").val(d.data.codeId);
                } else {
                    fun_alertMsg(d.message);
                }
            },
            error: function (e) {
                fun_alertMsg('提交异常！', function () {
                });
            }
        });
    }
</script>
</body>
@@include('html-foot.html')
</html>